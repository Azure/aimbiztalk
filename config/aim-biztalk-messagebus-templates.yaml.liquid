{%- assign aim_user_prefix = get_environment_variable("AIM_USER_PREFIX") | downcase -%}
{%- assign aim_unique_suffix = model.migration_target.unique_deployment_id | downcase -%}
{%- if aim_unique_suffix != "" -%}
  {%- assign aim_user_prefix = "" -%}
{%- endif -%}
{%- assign formatted_azure_primary_region = format_region(model.migration_target.azure_primary_region) | downcase -%}
{%- capture message_bus_application -%}
messagebusservice
{%- endcapture -%}
{%- capture message_bus_application_name -%}
AIM-MessageBus
{%- endcapture -%}
{%- capture message_bus_resource_group_name -%}
{{ aim_user_prefix }}rg-aimmsgbus-{{ model.migration_target.deployment_environment | downcase }}-{{ formatted_azure_primary_region }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture app_config_name -%}
{{ aim_user_prefix }}appcfg-aimrstore-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture key_vault_name -%}
{{ aim_user_prefix }}kv-aimrstore-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture key_vault_apim_subscription_secret_name -%}
aim-apim-subscriptionkey-unlimited
{%- endcapture -%}
{%- capture integration_account_name -%}
{{ aim_user_prefix }}intacc-aimartifactstore-{{ model.migration_target.deployment_environment | downcase }}-{{ formatted_azure_primary_region }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture api_management_service_name -%}
{{ aim_user_prefix }}apim-aimmsgbussvc-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture standard_app_service_plan_name -%}
{{ aim_user_prefix }}plan-logicapp-aimmsgbussvc-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture app_service_name -%}
{{ aim_user_prefix }}plan-aimmsgbussvc-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture storage_account_name -%}
{{ aim_user_prefix }}staimmsgbussvc{{ model.migration_target.deployment_environment | downcase }}01{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture func_routing_manager_name -%}
{{ aim_user_prefix }}func-aimroutemgr-{{ model.migration_target.deployment_environment | downcase }}-001-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture func_messaging_manager_name -%}
{{ aim_user_prefix }}func-aimmsgmgr-{{ model.migration_target.deployment_environment | downcase }}-001-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture app_insights_name -%}
{{ aim_user_prefix }}appi-aimmsgbusops-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture messagebus_logic_app_name -%}
{{ aim_user_prefix }}logic-aimmsgbussvc-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture routing_slip_router_logicapp_name -%}
{{ aim_user_prefix }}logic-aimroutingsliprouter-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture config_cache_updater_logicapp_name -%}
{{ aim_user_prefix }}logic-aimconfigcacheupdater-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture event_grid_subscribe_api_connection_name -%}
{{ aim_user_prefix }}apic-eventgridsubscribe-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture messagebus_event_grid_api_connection_name -%}
{{ aim_user_prefix }}apic-messagebuseventgrid-{{ model.migration_target.deployment_environment | downcase }}-{{ aim_unique_suffix }}
{%- endcapture -%}
{%- capture get_logic_app_callback_url_role_name -%}
{{ aim_user_prefix | append: ' ' }}{{ 'Get Logic App Callback Url' | append: ' ' }}{{ aim_unique_suffix }}
{%- endcapture -%}
#
# Templates are groups of files keyed with a template name.
#
# Each template file in a template is further keyed by the target deployment
# environment to allow for different templates where target environments might
# require a different shape or settings for the deployment of the resource.
#
# Templates also have different types such as Azure Resource Manager templates
# and parameter files or can be PowerShell script files.
#
# The templates files are text files of any format, but can use the Liquid template
# language during rendering that can use the target model to provide dynamic values
# to the template.
#
# For Liquid information, see:
# https://shopify.github.io/liquid/
# https://www.shopify.co.uk/partners/shopify-cheat-sheet 
#
# The configuration files themselves can also be rendered using the Liquid template language.
#
# Resource names and tags are taken from the best practice guidance of the Cloud Adoption Framework:
# https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging
#

# A resource template provides a set of files that are rendered as part of the
# Convert stage of the AIM tool.
resourceTemplates:

  # ------------------------------------------------------------------------------
  # Groups
  # ------------------------------------------------------------------------------

  - template: messageBusAzureResourceGroup
    templateType: microsoft.template.arm
    resourceName: {{ message_bus_resource_group_name }}
    resourceType: microsoft.groups.azureresourcegroup
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
    outputPath: messagebus/messagebusgroup
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusgroup/messagebusgroup.dev.parameters.json.liquid
          - messagebus/messagebusgroup/messagebusgroup.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusgroup/messagebusgroup.prod.parameters.json.liquid
          - messagebus/messagebusgroup/messagebusgroup.json.liquid

  # ------------------------------------------------------------------------------
  # Operations
  # ------------------------------------------------------------------------------

  - template: messageBusOpsAzureAppInsights
    templateType: microsoft.template.json
    resourceName: {{ app_insights_name }}
    resourceType: microsoft.services.azureappinsights
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusops
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusops/messagebusops.appi.dev.psparameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusops/messagebusops.appi.prod.psparameters.json.liquid

  # ------------------------------------------------------------------------------
  # Stores
  # ------------------------------------------------------------------------------

  # Currently no prefix for App Configuration in CAF:
  # https://github.com/MicrosoftDocs/cloud-adoption-framework/issues/182
  - template: routingStoreAzureAppConfiguration
    templateType: microsoft.template.arm
    resourceName: {{ app_config_name }}
    resourceType: microsoft.stores.azureappconfiguration
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
    outputPath: messagebus/routingstore
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingstore/routingstore.appcfg.json
      - env: ['dev']
        paths:
          - messagebus/routingstore/routingstore.appcfg.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/routingstore/routingstore.appcfg.prod.parameters.json.liquid

  - template: routingStoreAzureKeyVault
    templateType: microsoft.template.json
    resourceName: {{ key_vault_name }}
    resourceType: microsoft.stores.azurekeyvault
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_sku: Standard
    outputPath: messagebus/routingstore
    files:
      - env: ['dev']
        paths:
          - messagebus/routingstore/routingstore.kv.dev.psparameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/routingstore/routingstore.kv.prod.psparameters.json.liquid

  # Currently no prefix for Integration Accounts in CAF:
  # https://github.com/MicrosoftDocs/cloud-adoption-framework/issues/196
  - template: artifactStoreAzureIntegrationAccountBasic
    templateType: microsoft.template.arm
    resourceName: {{ integration_account_name }}
    resourceType: microsoft.stores.azureintegrationaccount
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_sku : free
    outputPath: messagebus/artifactstore
    files:
      - env: ['dev']
        paths:
          - messagebus/artifactstore/artifactstore.json.liquid
          - messagebus/artifactstore/artifactstore.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/artifactstore/artifactstore.json.liquid
          - messagebus/artifactstore/artifactstore.prod.parameters.json.liquid

  # ------------------------------------------------------------------------------
  # Security
  # ------------------------------------------------------------------------------

  - template: messageBusServiceAzureRole
    templateType: microsoft.template.json
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.security.azurerole
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagebusservice/messagebusservice.logicappsrole.json
  
  # ------------------------------------------------------------------------------
  # Services
  # ------------------------------------------------------------------------------

  - template: messageBusServiceAzureApiManagement
    templateType: microsoft.template.json
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.services.azureapimanagement
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - app_config_name: {{ app_config_name }}
      - key_vault_name: {{ key_vault_name }}
      - publisher_name: Microsoft
      - publisher_email: person@constoso.com
      - azure_sku: Developer
      - azure_sku_capacity: 1
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/messagebusservice.apim.dev.psparameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/messagebusservice.apim.prod.psparameters.json.liquid
  
  - template: routingStoreAzureApiManagement
    templateType: microsoft.template.arm
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.services.azureapimanagement
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_message_bus_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimroutingstore
      - app_config_name: {{ app_config_name }}
    outputPath: messagebus/routingstore
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingstore/routingstore.apim.json.liquid
      - env: ['dev']
        paths:
          - messagebus/routingstore/routingstore.apim.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/routingstore/routingstore.apim.prod.parameters.json.liquid

  - template: configManagerAzureApiManagement
    templateType: microsoft.template.arm
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.services.azureapimanagement
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_integration_account_name: {{ integration_account_name }}
      - azure_message_bus_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimconfigurationmanager
      - app_config_name: {{ app_config_name }}
    outputPath: messagebus/configmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/configmanager/configmanager.apim.json.liquid
      - env: ['dev']
        paths:
          - messagebus/configmanager/configmanager.apim.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/configmanager/configmanager.apim.prod.parameters.json.liquid

  - template: messageBusServiceAzureAppServiceConsumption
    templateType: microsoft.template.arm
    resourceName: {{ app_service_name }}
    resourceType: microsoft.services.azureappservice
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_sku: Y1
      - azure_sku_tier: Dynamic
      - azure_sku_capacity: 1
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/messagebusservice.plan.json.liquid
          - messagebus/messagebusservice/messagebusservice.plan.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/messagebusservice.plan.json.liquid
          - messagebus/messagebusservice/messagebusservice.plan.prod.parameters.json.liquid

  - template: messageBusServiceLogicAppServicePlanStandard
    templateType: microsoft.template.arm
    resourceName: {{ standard_app_service_plan_name }}
    resourceType: microsoft.services.azureappservice
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_sku: WS1
      - azure_sku_tier: WorkflowStandard
      - azure_sku_family: WS
      - azure_sku_capacity: 1
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/messagebusservice.logicapp.plan.json.liquid
          - messagebus/messagebusservice/messagebusservice.logicapp.plan.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/messagebusservice.logicapp.plan.json.liquid
          - messagebus/messagebusservice/messagebusservice.logicapp.plan.prod.parameters.json.liquid
  
  - template: messageBusServiceAzureStorageAccount
    templateType: microsoft.template.json
    resourceName: {{ storage_account_name }}
    resourceType: microsoft.services.azurestorage
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_storage_kind: StorageV2
      - azure_sku: Standard_LRS
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/messagebusservice.st.dev.psparameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/messagebusservice.st.prod.psparameters.json.liquid
  
  - template: routingManagerAzureFunctionConsumption
    templateType: microsoft.template.arm
    resourceName: {{ func_routing_manager_name }}
    resourceType: microsoft.services.azurefunction
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_storage_account_name: {{ storage_account_name }}
      - azure_app_insights_name: {{ app_insights_name }}
      - azure_app_service_plan_name: {{ app_service_name }}
      - azure_api_management_service_name: {{ api_management_service_name }}
    outputPath: messagebus/routingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingmanager/routingmanager.func.json
      - env: ['dev']
        paths:
          - messagebus/routingmanager/routingmanager.func.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/routingmanager/routingmanager.func.prod.parameters.json.liquid
  
  - template: routingManagerAzureApiManagement
    templateType: microsoft.template.arm
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.services.azureapimanagement
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - api_name: aimroutingmanager
      - routing_manager_func_name: {{ func_routing_manager_name }}
    outputPath: messagebus/routingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingmanager/routingmanager.apim.json.liquid
      - env: ['dev']
        paths:
          - messagebus/routingmanager/routingmanager.apim.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/routingmanager/routingmanager.apim.prod.parameters.json.liquid

  - template: messagingManagerAzureFunctionConsumption
    templateType: microsoft.template.arm
    resourceName: {{ func_messaging_manager_name }}
    resourceType: microsoft.services.azurefunction
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_storage_account_name: {{ storage_account_name }}
      - azure_app_insights_name: {{ app_insights_name }}
      - azure_app_service_plan_name: {{ app_service_name }}
      - azure_api_management_service_name: {{ api_management_service_name }}
    outputPath: messagebus/messagingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagingmanager/messagingmanager.func.json
      - env: ['dev']
        paths:
          - messagebus/messagingmanager/messagingmanager.func.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagingmanager/messagingmanager.func.prod.parameters.json.liquid
  
  - template: messagingManagerAzureApiManagement
    templateType: microsoft.template.arm
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.services.azureapimanagement
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - api_name: aimmessagingmanager
      - messaging_manager_func_name: {{ func_messaging_manager_name }}
    outputPath: messagebus/messagingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagingmanager/messagingmanager.apim.json
      - env: ['dev']
        paths:
          - messagebus/messagingmanager/messagingmanager.apim.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/messagingmanager/messagingmanager.apim.prod.parameters.json.liquid

  # ------------------------------------------------------------------------------
  # Consumption Workflows
  # ------------------------------------------------------------------------------

  - template: routingSlipRouterAzureLogicAppConsumption
    templateType: microsoft.template.arm
    resourceName: {{ routing_slip_router_logicapp_name }}
    resourceType: microsoft.workflows.azurelogicapp.consumption
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_message_bus_resource_group_name: {{ message_bus_resource_group_name }}
      - apim_service_name: {{ api_management_service_name }}  
    outputPath: messagebus/workflows/routingsliprouter
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/routingsliprouter/routingsliprouter.logicapp.json
      - env: ['dev']
        paths:
          - messagebus/workflows/routingsliprouter/routingsliprouter.logicapp.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/workflows/routingsliprouter/routingsliprouter.logicapp.prod.parameters.json.liquid

  - template: configCacheUpdaterAzureLogicAppConsumption
    templateType: microsoft.template.arm
    resourceName: {{ config_cache_updater_logicapp_name }}
    resourceType: microsoft.workflows.azurelogicapp.consumption
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_message_bus_resource_group_name: {{ message_bus_resource_group_name }}
      - apim_service_name: {{ api_management_service_name }}
      - app_config_store_name: {{ app_config_name }}
      - event_grid_api_connection_name: {{ event_grid_subscribe_api_connection_name }}
    outputPath: messagebus/workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/configcacheupdater/configcacheupdater.logicapp.json
      - env: ['dev']
        paths:
          - messagebus/workflows/configcacheupdater/configcacheupdater.logicapp.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/workflows/configcacheupdater/configcacheupdater.logicapp.prod.parameters.json.liquid

  - template: configCacheUpdaterEventGridApiConnectionConsumption
    templateType: microsoft.template.arm
    resourceName: {{ event_grid_subscribe_api_connection_name }}
    resourceType: microsoft.workflows.azurelogicapp.consumption
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/configcacheupdater/eventgridsubscribe.apiconnection.json
      - env: ['dev']
        paths:
          - messagebus/workflows/configcacheupdater/eventgridsubscribe.apiconnection.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/workflows/configcacheupdater/eventgridsubscribe.apiconnection.prod.parameters.json.liquid

  # ------------------------------------------------------------------------------
  # Standard Workflows
  # ------------------------------------------------------------------------------

  - template: messageBusApplicationAzureLogicAppStandard
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_logic_app_name }}
    resourceType: microsoft.workflows.azurelogicapp.standard
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_logic_app_name: {{ messagebus_logic_app_name }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_storage_account_name: {{ storage_account_name }}
      - azure_app_service_plan_name: {{ standard_app_service_plan_name }}
      - app_insights_name: {{ app_insights_name }}
      - apim_service_name: {{ api_management_service_name }}
      - messagebus_event_grid_api_connection_name: {{ messagebus_event_grid_api_connection_name }}
      - app_config_store_name: {{ app_config_name }}
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebus.logic.json
      - env: ['dev']
        paths:
          - messagebus/standard/messagebus.logic.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/standard/messagebus.logic.prod.parameters.json.liquid

  - template: messageBusApplicationAzureLogicAppStandardWorkflows
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_logic_app_name }}
    resourceType: microsoft.workflows.azurelogicapp.standard
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_logic_app_name: {{ messagebus_logic_app_name }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows/messagebus.logic.workflows
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebus.logic.workflows/.funcignore
          - messagebus/standard/messagebus.logic.workflows/.gitignore
          - messagebus/standard/messagebus.logic.workflows/connections.json
          - messagebus/standard/messagebus.logic.workflows/host.json
          - messagebus/standard/messagebus.logic.workflows/local.settings.json
          - messagebus/standard/messagebus.logic.workflows/parameters.json
          - messagebus/standard/messagebus.logic.workflows/parameters.local.json

  - template: messageBusApplicationAzureLogicAppStandardWorkflowsVsCode
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_logic_app_name }}
    resourceType: microsoft.workflows.azurelogicapp.standard
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_logic_app_name: {{ messagebus_logic_app_name }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows/messagebus.logic.workflows/.vscode
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebus.logic.workflows/.vscode/extensions.json
          - messagebus/standard/messagebus.logic.workflows/.vscode/launch.json
          - messagebus/standard/messagebus.logic.workflows/.vscode/settings.json
          - messagebus/standard/messagebus.logic.workflows/.vscode/tasks.json

  - template: messageBusApplicationAzureLogicAppStandardWorkflowsWorkflowDesigntime
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_logic_app_name }}
    resourceType: microsoft.workflows.azurelogicapp.standard
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_logic_app_name: {{ messagebus_logic_app_name }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows/messagebus.logic.workflows/workflow-designtime
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebus.logic.workflows/workflow-designtime/host.json
          - messagebus/standard/messagebus.logic.workflows/workflow-designtime/local.settings.json

  - template: messageBusApplicationAzureEventGridApiConnectionStandard
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_event_grid_api_connection_name }}
    resourceType: microsoft.web.connections
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_api_connection_version: V2
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebuseventgrid.apiconnection.json
      - env: ['dev']
        paths:
          - messagebus/standard/messagebuseventgrid.apiconnection.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/standard/messagebuseventgrid.apiconnection.prod.parameters.json.liquid

  - template: messageBusApplicationAzureEventGridApiConnectionAccessPolicy
    templateType: microsoft.template.arm
    resourceName: {{ messagebus_event_grid_api_connection_name }}
    resourceType: microsoft.web.connections
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - messagebus_logic_app_name: {{ messagebus_logic_app_name }}
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebuseventgrid.apicaccesspolicy.json
      - env: ['dev']
        paths:
          - messagebus/standard/messagebuseventgrid.apicaccesspolicy.dev.parameters.json.liquid
      - env: ['prod']
        paths:
          - messagebus/standard/messagebuseventgrid.apicaccesspolicy.prod.parameters.json.liquid

  - template: configCacheUpdaterAzureLogicAppStandard
    templateType: microsoft.template.arm
    resourceName: configcacheupdater
    resourceType: microsoft.workflows.azurelogicapp.standard
    tags:
      - Application: {{ message_bus_application_name }}
      - Env: {{ model.migration_target.deployment_environment | downcase }}
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_logic_app_name: {{ messagebus_logic_app_name }}
    outputPath: messagebus/workflows/messagebus.logic.workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/messagebus.logic.workflows/configcacheupdater/workflow.json

  # ------------------------------------------------------------------------------
  # Scripts
  # ------------------------------------------------------------------------------

  - template: deployConsumptionResources
    templateType: microsoft.template.powershell
    resourceName: deploy-resources
    resourceType: microsoft.scripts.powershell
    outputPath: 
    parameters: 
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - aim_unique_suffix: {{ aim_unique_suffix }}
    files:
      - env: ['dev', 'prod']
        paths:
          - deploy/consumption/Deploy-All.bat
          - deploy/consumption/Deploy-All-Unattended.bat
          - deploy/consumption/TearDown-All.bat
          - deploy/consumption/Deploy-All.ps1.liquid
          - deploy/consumption/TearDown-All.ps1.liquid

  - template: deployConsumptionLiteResources
    templateType: microsoft.template.powershell
    resourceName: deploy-resources
    resourceType: microsoft.scripts.powershell
    outputPath: 
    parameters: 
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - aim_unique_suffix: {{ aim_unique_suffix }}
    files:
      - env: ['dev', 'prod']
        paths:
          - deploy/consumptionlite/Deploy-All.bat
          - deploy/consumptionlite/Deploy-All-Unattended.bat
          - deploy/consumptionlite/TearDown-All.bat
          - deploy/consumptionlite/Deploy-All.ps1.liquid
          - deploy/consumptionlite/TearDown-All.ps1.liquid

  - template: deployStandardResources
    templateType: microsoft.template.powershell
    resourceName: deploy-resources
    resourceType: microsoft.scripts.powershell
    outputPath: 
    parameters: 
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - aim_unique_suffix: {{ aim_unique_suffix }}
    files:
      - env: ['dev', 'prod']
        paths:
          - deploy/standard/Deploy-All.bat
          - deploy/standard/Deploy-All-Unattended.bat
          - deploy/standard/TearDown-All.bat
          - deploy/standard/Deploy-All.ps1.liquid
          - deploy/standard/TearDown-All.ps1.liquid

  - template: deployStandardLiteResources
    templateType: microsoft.template.powershell
    resourceName: deploy-resources
    resourceType: microsoft.scripts.powershell
    outputPath: 
    parameters: 
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - aim_unique_suffix: {{ aim_unique_suffix }}
    files:
      - env: ['dev', 'prod']
        paths:
          - deploy/standardlite/Deploy-All.bat
          - deploy/standardlite/Deploy-All-Unattended.bat
          - deploy/standardlite/TearDown-All.bat
          - deploy/standardlite/Deploy-All.ps1.liquid
          - deploy/standardlite/TearDown-All.ps1.liquid

  - template: deployMessageBusGroup
    templateType: microsoft.template.powershell
    resourceName: {{ message_bus_resource_group_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
    outputPath: messagebus/messagebusgroup
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusgroup/Deploy-10-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/New-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/TearDown-10-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/Remove-MessageBusGroup.ps1.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusgroup/Deploy-10-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/New-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/TearDown-10-MessageBusGroup.ps1.liquid
          - messagebus/messagebusgroup/Remove-MessageBusGroup.ps1.liquid

  - template: deployMessageBusOpsAppInsights
    templateType: microsoft.template.powershell
    resourceName: {{ app_insights_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusops
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusops/Deploy-20-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/New-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/TearDown-20-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/Remove-MessageBusOps-AppInsights.ps1.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusops/Deploy-20-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/New-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/TearDown-20-MessageBusOps-AppInsights.ps1.liquid
          - messagebus/messagebusops/Remove-MessageBusOps-AppInsights.ps1.liquid

  - template: deployMessageBusServiceRole
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - role_name: {{ get_logic_app_callback_url_role_name }}
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagebusservice/Deploy-5-MessageBusService-Role.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-Role.ps1
          - messagebus/messagebusservice/TearDown-5-MessageBusService-Role.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-Role.ps1

  - template: deployMessageBusGroupApimRoleAssignment
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - azure_message_bus_resource_group_name: {{ message_bus_resource_group_name }}
      - role_name: Reader
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagebusservice/Deploy-35-MessageBusService-ApiManagement-RoleAssignment.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-ApiManagement-RoleAssignment.ps1
          - messagebus/messagebusservice/TearDown-35-MessageBusService-ApiManagement-RoleAssignment.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-ApiManagement-RoleAssignment.ps1          

  - template: deployMessageBusServiceApiManagement
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagebusservice/Deploy-30-MessageBusService-ApiManagement.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-ApiManagement.ps1
          - messagebus/messagebusservice/TearDown-30-MessageBusService-ApiManagement.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-ApiManagement.ps1

  - template: deployMessageBusServiceLogicAppServicePlanStandard
    templateType: microsoft.template.powershell
    resourceName: {{ standard_app_service_plan_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/Deploy-30-MessageBusService-LogicAppPlan.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-LogicAppPlan.ps1
          - messagebus/messagebusservice/TearDown-30-MessageBusService-LogicAppPlan.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-LogicAppPlan.ps1
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/Deploy-30-MessageBusService-LogicAppPlan.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-LogicAppPlan.ps1
          - messagebus/messagebusservice/TearDown-30-MessageBusService-LogicAppPlan.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-LogicAppPlan.ps1

  - template: deployMessageBusServiceAppService
    templateType: microsoft.template.powershell
    resourceName: {{ app_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/Deploy-30-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/TearDown-30-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-AppService.ps1.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/Deploy-30-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/TearDown-30-MessageBusService-AppService.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-AppService.ps1.liquid

  - template: deployMessageBusServiceStorage
    templateType: microsoft.template.powershell
    resourceName: {{ storage_account_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagebusservice
    files:
      - env: ['dev']
        paths:
          - messagebus/messagebusservice/Deploy-20-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/TearDown-20-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-StorageAccount.ps1.liquid
      - env: ['prod']
        paths:
          - messagebus/messagebusservice/Deploy-20-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/New-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/TearDown-20-MessageBusService-StorageAccount.ps1.liquid
          - messagebus/messagebusservice/Remove-MessageBusService-StorageAccount.ps1.liquid

  - template: deployRoutingStoreConfig
    templateType: microsoft.template.powershell
    resourceName: {{ app_config_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - key_vault_name: {{ key_vault_name }}
    outputPath: messagebus/routingstore
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingstore/Deploy-20-RoutingStore-AppConfig.ps1.liquid
          - messagebus/routingstore/New-RoutingStore-AppConfig.ps1
          - messagebus/routingstore/TearDown-20-RoutingStore-AppConfig.ps1.liquid
          - messagebus/routingstore/Remove-RoutingStore-AppConfig.ps1

  - template: deployRoutingStoreVault
    templateType: microsoft.template.powershell
    resourceName: {{ key_vault_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/routingstore
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingstore/Deploy-15-RoutingStore-KeyVault.ps1.liquid
          - messagebus/routingstore/New-RoutingStore-KeyVault.ps1
          - messagebus/routingstore/TearDown-15-RoutingStore-KeyVault.ps1.liquid
          - messagebus/routingstore/Remove-RoutingStore-KeyVault.ps1

  - template: deployArtifactStore
    templateType: microsoft.template.powershell
    resourceName: {{ integration_account_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/artifactstore
    files:
      - env: ['dev']
        paths:
          - messagebus/artifactstore/Deploy-20-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/New-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/TearDown-20-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/Remove-ArtifactStore.ps1.liquid
      - env: ['prod']
        paths:
          - messagebus/artifactstore/Deploy-20-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/New-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/TearDown-20-ArtifactStore.ps1.liquid
          - messagebus/artifactstore/Remove-ArtifactStore.ps1.liquid

  - template: deployRoutingStoreApi
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimroutingstore
    outputPath: messagebus/routingstore
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingstore/Deploy-40-RoutingStore-ApiManagement.ps1.liquid
          - messagebus/routingstore/New-RoutingStore-ApiManagement.ps1
          - messagebus/routingstore/TearDown-40-RoutingStore-ApiManagement.ps1.liquid
          - messagebus/routingstore/Remove-RoutingStore-ApiManagement.ps1

  - template: deployConfigManagerApi
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimconfigurationmanager
    outputPath: messagebus/configmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/configManager/Deploy-40-ConfigManager-ApiManagement.ps1.liquid
          - messagebus/configManager/New-ConfigManager-ApiManagement.ps1
          - messagebus/configManager/TearDown-40-ConfigManager-ApiManagement.ps1.liquid
          - messagebus/configManager/Remove-ConfigManager-ApiManagement.ps1

  - template: deployRoutingManagerFunc
    templateType: microsoft.template.powershell
    resourceName: {{ func_routing_manager_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/routingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingmanager/Deploy-50-RoutingManager-Function.ps1.liquid
          - messagebus/routingmanager/New-RoutingManager-Function.ps1
          - messagebus/routingmanager/TearDown-50-RoutingManager-Function.ps1.liquid
          - messagebus/routingmanager/Remove-RoutingManager-Function.ps1
          - messagebus/routingmanager/Microsoft.AzureIntegrationMigration.FunctionApp.RoutingManager.zip

  - template: deployRoutingManagerApi
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimroutingmanager
    outputPath: messagebus/routingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/routingmanager/Deploy-60-RoutingManager-ApiManagement.ps1.liquid
          - messagebus/routingmanager/New-RoutingManager-ApiManagement.ps1
          - messagebus/routingmanager/TearDown-60-RoutingManager-ApiManagement.ps1.liquid
          - messagebus/routingmanager/Remove-RoutingManager-ApiManagement.ps1

  - template: deployMessagingManagerFunc
    templateType: microsoft.template.powershell
    resourceName: {{ func_messaging_manager_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/messagingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagingmanager/Deploy-50-MessagingManager-Function.ps1.liquid
          - messagebus/messagingmanager/New-MessagingManager-Function.ps1
          - messagebus/messagingmanager/TearDown-50-MessagingManager-Function.ps1.liquid
          - messagebus/messagingmanager/Remove-MessagingManager-Function.ps1
          - messagebus/messagingmanager/Microsoft.AzureIntegrationMigration.FunctionApp.MessagingManager.zip
  
  - template: deployMessagingManagerApi
    templateType: microsoft.template.powershell
    resourceName: {{ api_management_service_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - api_name: aimmessagingmanager
    outputPath: messagebus/messagingmanager
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/messagingmanager/Deploy-60-MessagingManager-ApiManagement.ps1.liquid
          - messagebus/messagingmanager/New-MessagingManager-ApiManagement.ps1
          - messagebus/messagingmanager/TearDown-60-MessagingManager-ApiManagement.ps1.liquid
          - messagebus/messagingmanager/Remove-MessagingManager-ApiManagement.ps1

  - template: deployRoutingSlipRouterAzureLogicAppConsumption
    templateType: microsoft.template.powershell
    resourceName: {{ routing_slip_router_logicapp_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - key_vault_name: {{ key_vault_name }}
      - key_vault_apim_subscription_secret_name: {{ key_vault_apim_subscription_secret_name }}
    outputPath: messagebus/workflows/routingsliprouter
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/routingsliprouter/Deploy-80-RoutingSlipRouter-LogicApp.ps1.liquid
          - messagebus/workflows/routingsliprouter/New-RoutingSlipRouter-LogicApp.ps1
          - messagebus/workflows/routingsliprouter/TearDown-80-RoutingSlipRouter-LogicApp.ps1.liquid
          - messagebus/workflows/routingsliprouter/Remove-RoutingSlipRouter-LogicApp.ps1

  - template: deployConfigCacheUpdaterAzureLogicAppConsumption
    templateType: microsoft.template.powershell
    resourceName: {{ config_cache_updater_logicapp_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - key_vault_name: {{ key_vault_name }}
      - key_vault_apim_subscription_secret_name: {{ key_vault_apim_subscription_secret_name }}
    outputPath: messagebus/workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/configcacheupdater/Deploy-90-ConfigCacheUpdater-LogicApp-Disabled.ps1.liquid
          - messagebus/workflows/configcacheupdater/Deploy-110-ConfigCacheUpdater-LogicApp-Enabled.ps1.liquid
          - messagebus/workflows/configcacheupdater/New-ConfigCacheUpdater-LogicApp.ps1
          - messagebus/workflows/configcacheupdater/TearDown-90-ConfigCacheUpdater-LogicApp.ps1.liquid
          - messagebus/workflows/configcacheupdater/Remove-ConfigCacheUpdater-LogicApp.ps1

  - template: deployConfigCacheUpdaterEventGridApiConnectionConsumption
    templateType: microsoft.template.powershell
    resourceName: {{ event_grid_subscribe_api_connection_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/configcacheupdater/Deploy-80-EventGridSubscribe-ApiConnection.ps1.liquid
          - messagebus/workflows/configcacheupdater/New-EventGridSubscribe-ApiConnection.ps1
          - messagebus/workflows/configcacheupdater/TearDown-80-EventGridSubscribe-ApiConnection.ps1.liquid
          - messagebus/workflows/configcacheupdater/Remove-EventGridSubscribe-ApiConnection.ps1

  - template: deployConfigCacheUpdaterAppConfigRoleAssignmentConsumption
    templateType: microsoft.template.powershell
    resourceName: {{ event_grid_subscribe_api_connection_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - app_config_store_name: {{ app_config_name }}
      - logic_app_name: {{ config_cache_updater_logicapp_name }}
      - role_name: Contributor
    outputPath: messagebus/workflows/configcacheupdater
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/workflows/configcacheupdater/Deploy-100-AppConfigStore-RoleAssignment.ps1.liquid
          - messagebus/workflows/configcacheupdater/New-AppConfigStore-RoleAssignment.ps1
          - messagebus/workflows/configcacheupdater/TearDown-100-AppConfigStore-RoleAssignment.ps1.liquid
          - messagebus/workflows/configcacheupdater/Remove-AppConfigStore-RoleAssignment.ps1

  - template: deployMessageBusAzureLogicAppStandard
    templateType: microsoft.template.powershell
    resourceName: {{ messagebus_logic_app_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - key_vault_name: {{ key_vault_name }}
      - key_vault_apim_subscription_secret_name: {{ key_vault_apim_subscription_secret_name }}
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:
          - messagebus/standard/Deploy-90-MessageBus-LogicApp.ps1.liquid
          - messagebus/standard/New-MessageBus-LogicApp.ps1
          - messagebus/standard/TearDown-90-MessageBus-LogicApp.ps1.liquid
          - messagebus/standard/Remove-MessageBus-LogicApp.ps1

  - template: deployMessageBusAzureEventGridApiConnectionStandard
    templateType: microsoft.template.powershell
    resourceName: {{ messagebus_event_grid_api_connection_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:                                       
          - messagebus/standard/Deploy-80-MessageBusEventGrid-ApiConnection.ps1.liquid
          - messagebus/standard/New-MessageBusEventGrid-ApiConnection.ps1
          - messagebus/standard/Remove-MessageBusEventGrid-ApiConnection.ps1
          - messagebus/standard/TearDown-80-MessageBusEventGrid-ApiConnection.ps1.liquid

  - template: deployMessageBusAzureEventGridApiConnectionAccessPolicyStandard
    templateType: microsoft.template.powershell
    resourceName: {{ messagebus_event_grid_api_connection_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:                                       
          - messagebus/standard/Deploy-95-MessageBusEventGrid-ApiConnectionAccessPolicy.ps1.liquid
          - messagebus/standard/New-MessageBusEventGrid-ApiConnectionAccessPolicy.ps1

  - template: deployMessageBusAppConfigStoreRoleAssignmentStandard
    templateType: microsoft.template.powershell
    resourceName: {{ messagebus_event_grid_api_connection_name }}
    resourceType: microsoft.scripts.powershell
    parameters:
      - azure_primary_region: {{ model.migration_target.azure_primary_region }}
      - azure_secondary_region: {{ model.migration_target.azure_secondary_region }}
      - azure_subscription_id: {{ model.migration_target.azure_subscription_id }}
      - azure_resource_group_name: {{ message_bus_resource_group_name }}
      - app_config_store_name: {{ app_config_name }}
      - logic_app_name: {{ messagebus_logic_app_name }}
      - role_name: Contributor
    outputPath: messagebus/workflows
    files:
      - env: ['dev', 'prod']
        paths:                                       
          - messagebus/standard/Deploy-95-AppConfigStore-RoleAssignment.ps1.liquid
          - messagebus/standard/New-AppConfigStore-RoleAssignment.ps1
          - messagebus/standard/Remove-AppConfigStore-RoleAssignment.ps1
          - messagebus/standard/TearDown-95-AppConfigStore-RoleAssignment.ps1.liquid